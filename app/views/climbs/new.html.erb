<%
@title = "Climb That Shit"
@back_url = climbs_path
@extra_header = button_to "Save", climbs_path, { class: "btn btn-success btn-sm" }
%>

<div class="card">
  <div class="row mx-1 mb-2">
    <select id="routeSets" class="form-control">
      <% @active_route_sets.each do |route_set| %>
      <option value="<%= route_set.id %>">
        <%= route_set.name %>
      </option>
      <% end %>
    </select>
  </div>

  <div id="map" class="map">
    <img src="/GroundFloor.png" id="floorBackground" />
  </div>
</div>

<script>
  $(() => {
    const $map = $('#map')
    const $routeSets = $('#routeSets')
    const $done = $('#done')
    const $routeStates = $('<input type="hidden" name="route_states" id="route_states" />')
    const routeSets = <%= raw @routes.to_json %>
    let $routes = []

    const changeRoute = () => {
      $routes.forEach($route => {
        $route.remove()
      })
      $routes = []

      const newRoutes = routeSets[$routeSets.val()]
      newRoutes.forEach(addRoute)
    }

    const addRoute = route => {
      const $route = $(`<div class="route" style="left: ${(route.pos_x / 400) * 100}%; top: ${(route.pos_y / 873) * 100}%">${icon(route.status)}</div>`)
      $route.click(() => clickRoute(route))
      route.$elem = $route
      $map.append($route)
      $routes.push($route)
    }

    const clickRoute = route => {
      if(route.completed === undefined)
        route.completed = true
      else if(route.completed)
        route.completed = false
      else if(route.completed === false)
        route.completed = undefined

      route.$elem.text(icon(route.completed))

      updateRouteStates()
    }

    const icon = state => {
      switch(state) {
        case true:
          return '✔'
        case false:
          return '❌'
        default:
          return '🟡'
      }
    }

    const updateRouteStates = () => {
      const status = {
        undefined: 'not_attempted',
        false: 'failed',
        true: 'sent'
      }

      const routeStates = Object.keys(routeSets).map(routeSetId => {
        return routeSets[routeSetId].map(route => ({
          routeId: route.id,
          status: status[route.completed]
        }))
      }).flat()

      $routeStates.val(JSON.stringify(routeStates))
    }

    const $form = $('[action="<%= climbs_path %>"]')
    $form.append($routeStates)

    $routeSets.change(changeRoute)
    changeRoute()
    updateRouteStates()
  })
</script>
