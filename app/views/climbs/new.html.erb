<%
@title = "Climb That Shit"
@back_url = climbs_path
@extra_header = button_to "Done", climbs_path, { class: "btn btn-success btn-sm" }
%>

<div class="row mx-1">
  <select id="routeSets" class="form-control">
    <% @active_route_sets.each do |route_set| %>
    <option value="<%= route_set.id %>">
      <%= route_set.name %>
    </option>
    <% end %>
  </select>
</div>

<div id="map" style="position: relative">
  <img src="/GroundFloor.png" id="floorBackground" />
</div>

<script>
  const $map = $('#map')
  const $routeSets = $('#routeSets')
  const $done = $('#done')
  const $routeStates = $('<input type="hidden" name="route_states" id="route_states" />')
  const routeSets = <%= raw @routes.to_json %>
  let $routes = []

  const changeRoute = () => {
    $routes.forEach($route => {
      $route.remove()
    })
    $routes = []

    const newRoutes = routeSets[$routeSets.val()]
    newRoutes.forEach(addRoute)
  }

  const addRoute = route => {
    const $route = $(`<div class="route" style="left: ${route.pos_x}px; top: ${route.pos_y}px">${icon(route.completed)}</div>`)
    $route.click(() => clickRoute(route))
    route.$elem = $route
    $map.append($route)
    $routes.push($route)
  }

  const clickRoute = route => {
    if(route.completed === undefined)
      route.completed = true
    else if(route.completed)
      route.completed = false
    else if(route.completed === false)
      route.completed = undefined

    route.$elem.text(icon(route.completed))

    updateRouteStates()
  }

  const icon = state => {
    switch(state) {
      case true:
        return '✔'
      case false:
        return '❌'
      default:
        return '🟡'
    }
  }

  const updateRouteStates = () => {
    const status = {
      undefined: 'not_attempted',
      false: 'failed',
      true: 'sent'
    }

    const routeStates = Object.keys(routeSets).map(routeSetId => {
      return routeSets[routeSetId].map(route => ({
        routeId: route.id,
        status: status[route.completed]
      }))
    }).flat()

    $routeStates.val(JSON.stringify(routeStates))
  }

  const $form = $('[action="<%= climbs_path %>"]')
  $form.append($routeStates)

  $routeSets.change(changeRoute)
  changeRoute()
  updateRouteStates()
</script>
