<%
@title = "#{@climb.name}"
@back_url = climbs_path
@extra_header = "<button id='share' class='btn btn-sm btn-secondary' data-test='share'>Share</button>"
%>

<div class="accordion" id="accordionExample">
  <% @route_sets.each_with_index do |route_set, i| %>
  <div class="card" data-test="route-set-<%= route_set.id %>">
    <div class="card-header" data-toggle="collapse" data-target="#collapse-<%= i %>">
      <h5 class="mb-0 d-flex justify-content-between">
        <div>
          <%= route_set.grade.name.titleize %>
        </div>
        <div>
          <%= attempted_routes(route_set) %>
        </div>
        <div>
          <%= success_rate(route_set) %>‚úî
        </div>
        <div>
          <%= new_wins_count_for_set(route_set) %>‚≠ê
        </div>
      </h5>
    </div>

    <div id="collapse-<%= i %>" class="collapse map-set">
      <div class="card-body">
        <div style="display: flex;">
          <button class="floorplan-prev">&lt;</button>
          <span style="flex-grow: 1; text-align: center" id="floorplan_name"></span>
          <button class="floorplan-next">&gt;</button>
        </div>
        <div id="map-<%= route_set.id %>" class="map" style="background-color: <%= route_set.grade.map_tint_colour %>">
          <% @place.floorplan.data.each_with_index do |floor, index| %>
            <img src="<%= url_for(@place.floorplan.images.find(floor['image_id'])) %>" class="floorplan" data-floorplan-id="<%= index %>" style="opacity: 0.8" />
          <% end %>
        </div>
      </div>
    </div>
  </div>
  <% end %>
</div>

<script>
  $(() => {
    const $map = $('.map')
    const $routeSets = $('#routeSets')
    const $done = $('#done')
    const $routeStates = $('<input type="hidden" name="route_states" id="route_states" />')
    const routeSets = <%= raw @routes.to_json %>
    const previousStates = <%= raw previous_states.to_json %>
    const newWins = <%= raw new_wins.to_json %>

    const floorplanData = <%= raw @place.floorplan.data.to_json %>
    const nonDeletedFloorplans = floorplanData.filter(item => !item.deleted);
    let currentFloorplans = {};

    const initRouteStates = () => {
      const initialRouteStates = <%= raw @climb.route_states.to_json %>
      Object.keys(routeSets).forEach(routeSetKey => {
        routeSets[routeSetKey].forEach(route => {
          const routeState = initialRouteStates.filter(initialRouteState => initialRouteState.route_id == route.id)[0]

          if(routeState)
            route.status = routeState.status
        })
      })
    }

    const addRoute = (route, routeSet) => {
      const $floorplan = $('.floorplan')
      const $route = $(`<div class="route" data-route-id="${route.id}" style="left: ${(route.pos_x / $floorplan[route.floor].naturalWidth) * 100}%; top: ${(route.pos_y / $floorplan[route.floor].naturalHeight) * 100}%" data-floor="${route.floor}">${icon(route)}</div>`)
      $route.click(() => clickRoute(route))
      route.$elem = $route
      $('#map-' + routeSet).append($route)
    }

    const setRoute = (routeSet) => {
      const newRoutes = routeSets[routeSet]
      newRoutes.forEach(newRoute => addRoute(newRoute, routeSet))
    }

    const icon = route => {
      const newWin = newWins.filter(newWin => newWin.route_id == route.id)[0]
      let icon = ''

      if(newWin)
        icon = '‚≠ê'

      switch(route.status) {
        case 'flashed':
          return `${icon}‚ö°`
        case 'sent':
          return `${icon}‚úî`
        case 'failed':
          return '‚ùå'
      }

      switch(previousStates[route.id]) {
        case 'sent':
          return 'üü¢'
        case 'failed':
          return 'üü°'
        default:
          return 'üî¥'
      }
    }

    const switchFloorplan = ($elem, floorplan) => {
      $elem.find('#floorplan_name').text(floorplan.name);
      $elem.find('.floorplan').hide();
      $elem.find('.floorplan[data-floorplan-id=' + floorplan.id + ']').show();
      $elem.find('.route').hide();
      $elem.find('.route[data-floor=' + floorplan.id + ']').show();
      currentFloorplans[$elem] = floorplan;
    }

    $('.floorplan-prev').click((e) => {
      const $elem = $(e.currentTarget).closest('.map-set');
      const floorplans = nonDeletedFloorplans;
      const next = floorplans.indexOf(currentFloorplans[$elem])-1;
      if(next < 0)
        switchFloorplan($elem, floorplans[[floorplans.length-1]]);
      else
        switchFloorplan($elem, floorplans[next]);
    });

    $('.floorplan-next').click((e) => {
      const $elem = $(e.currentTarget).closest('.map-set');
      const floorplans = nonDeletedFloorplans;
      const next = floorplans.indexOf(currentFloorplans[$elem])+1;
      if(next >= floorplans.length)
        switchFloorplan($elem, floorplans[0]);
      else
        switchFloorplan($elem, floorplans[next]);
    });

    $('.floorplan:first')[0].onload = () => {
      initRouteStates()
      Object.keys(routeSets).forEach(routeSet => setRoute(routeSet))

      $('.map-set').each((id) => {
        switchFloorplan($($('.map-set')[id]), floorplanData[0]);
      })
    };

    $('#share').click(() => {
      navigator.share({
        title: 'aSENDit Climb <%= @climb.name %>',
        url: '<%= climb_share_url(@climb) %>'
      })
    })
  })
</script>
